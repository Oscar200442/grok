<script>
    // DOM elements for chatbot
    const chatWindow = document.getElementById('chat-window');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    let lastBotResponse = '';

    // DOM elements for TTS
    const ttsInput = document.getElementById('tts-input');
    const ttsPlayBtn = document.getElementById('tts-play-btn');
    const ttsStopBtn = document.getElementById('tts-stop-btn');
    const copyLastResponseBtn = document.getElementById('copy-last-response-btn');
    
    // Helper function to add messages to the chat window
    function addMessage(sender, message, isTyping = false) {
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('flex', 'flex-col', sender === 'user' ? 'items-end' : 'items-start');

        const messageBubble = document.createElement('div');
        messageBubble.classList.add('message-bubble');
        
        if (sender === 'user') {
            messageBubble.classList.add('user-bubble');
        } else {
            messageBubble.classList.add('bot-bubble-iphone');
        }
        
        if (isTyping) {
            messageBubble.classList.add('typing');
            messageBubble.innerText = "The AI is thinking...";
        } else {
            const convertMarkdown = (text) => {
                return text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            };
            messageBubble.innerHTML = convertMarkdown(message);
        }
        
        messageWrapper.appendChild(messageBubble);
        chatWindow.appendChild(messageWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return messageBubble;
    }

    // New function to simulate typing out the response
    function simulateTyping(text, bubbleElement) {
        lastBotResponse = text;
        let i = 0;
        const speed = 25;
        bubbleElement.innerHTML = '';

        function typeWriter() {
            if (i < text.length) {
                const char = text[i];
                
                if (char === '*') {
                    let endIndex = text.indexOf('*', i + 1);
                    if (endIndex !== -1) {
                        const boldText = text.substring(i + 1, endIndex);
                        bubbleElement.innerHTML += `<em>${boldText}</em>`;
                        i = endIndex + 1;
                    } else {
                        bubbleElement.innerHTML += char;
                        i++;
                    }
                } else {
                    bubbleElement.innerHTML += char;
                    i++;
                }

                chatWindow.scrollTop = chatWindow.scrollHeight;
                setTimeout(typeWriter, speed);
            }
        }
        typeWriter();
    }

    // Function to send a message to the chatbot API
    async function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (!userMessage) return;

        addMessage('user', userMessage);
        chatInput.value = '';

        const typingBubble = addMessage('bot', '', true);

        try {
            const response = await fetch('/api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: userMessage })
            });
            const data = await response.json();
            
            typingBubble.classList.remove('typing');
            
            if (data.error) {
                simulateTyping(`Error: ${data.error}`, typingBubble);
            } else {
                simulateTyping(data.text, typingBubble);
            }
        } catch (error) {
            console.error('Error:', error);
            typingBubble.classList.remove('typing');
            simulateTyping('Could not connect to the server.', typingBubble);
        }
    }
    
    // Event listener for chatbot
    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Event listener for TTS Play (OPDATERET TIL AT BRUGE VERCEL API)
    ttsPlayBtn.addEventListener('click', async () => {
        const textToSpeak = ttsInput.value.trim();
        if (textToSpeak) {
            try {
                ttsPlayBtn.disabled = true;
                ttsStopBtn.disabled = true;

                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: textToSpeak })
                });

                if (!response.ok) {
                    throw new Error('Fejl ved generering af tale.');
                }

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                
                window.currentAudio = audio;
                audio.play();

                audio.onended = () => {
                    ttsPlayBtn.disabled = false;
                    ttsStopBtn.disabled = false;
                };

            } catch (error) {
                console.error('Fejl ved afspilning af tale:', error);
                ttsPlayBtn.disabled = false;
                ttsStopBtn.disabled = false;
            }
        }
    });

    // Event listener for TTS Stop (OPDATERET TIL AT BRUGE VERCEL API)
    ttsStopBtn.addEventListener('click', () => {
        if (window.currentAudio) {
            window.currentAudio.pause();
            window.currentAudio.currentTime = 0;
            ttsPlayBtn.disabled = false;
            ttsStopBtn.disabled = false;
        }
    });

    // Ny event listener for kopieringsknappen
    copyLastResponseBtn.addEventListener('click', () => {
        if (lastBotResponse) {
            const cleanText = lastBotResponse.replace(/\*([^*]+)\*/g, '$1');
            ttsInput.value = cleanText;
        }
    });
</script>
